# Copyright Â© 2025 Cisco Systems, Inc. and its affiliates.
# All rights reserved.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


name: Test Signing and Pushing

env:
  TEST_RECORD: "./test-data/records/action-test.json"

on:
  workflow_dispatch:
    inputs:
      record_version:
        description: 'Record version (must be unique - required for manual dispatch, defaults to commit SHA for automated runs)'
        required: true
        type: string
  pull_request:
    branches: [ main ]

jobs:
  test-push-fake-credentials:
    name: Test push with fake credentials
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Agent directory push and sign reusable action
        id: test_fake_cred_push
        uses: ./
        continue-on-error: true
        with:
          dirctl_client_id: "fake-client-id"
          dirctl_secret: "fake-secret"
          record_file: ${{ env.TEST_RECORD }}
          organization_name: "test-github-actions-org"

      - name: Verify and upload
        uses: ./.github/actions/verify-and-upload
        with:
          verification_type: failure
          outcome: ${{ steps.test_fake_cred_push.outcome }}
          expected_error: "failed to authenticate with API key"
          test_name: "test-push-fake-credentials"

  test-pushing-unsigned-record-without-signing:
    name: Test pushing unsigned record without signing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Set version
        id: set_version
        uses: ./.github/actions/set-version
        with:
          version: ${{ inputs.record_version }}

      - name: Agent directory push reusable action
        id: test_unsigned_push
        uses: ./
        with:
          dirctl_client_id: ${{ secrets.DIRCTL_APIKEY_CLIENT_ID }}
          dirctl_secret: ${{ secrets.DIRCTL_APIKEY_SECRET }}
          record_file: ${{ env.TEST_RECORD }}
          organization_name: "test-github-actions-org"
          record_name: "gha-test-record"
          record_version: ${{ steps.set_version.outputs.version }}

      - name: Verify and upload
        uses: ./.github/actions/verify-and-upload
        with:
          verification_type: success
          outcome: ${{ steps.test_unsigned_push.outcome }}
          test_name: "test-pushing-unsigned-record-without-signing"

  test-push-already-existing-record:
    name: Test pushing already existing record
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Agent directory push and sign reusable action
        id: test_push_existing
        uses: ./
        continue-on-error: true
        with:
          dirctl_client_id: ${{ secrets.DIRCTL_APIKEY_CLIENT_ID }}
          dirctl_secret: ${{ secrets.DIRCTL_APIKEY_SECRET }}
          record_file: ${{ env.TEST_RECORD }}
          organization_name: "test-github-actions-org"
          cosign_private_key: ${{ secrets.COSIGN_KEY }}
          cosign_private_key_password: ${{ secrets.COSIGN_PASSWORD }}

      - name: Verify and upload
        uses: ./.github/actions/verify-and-upload
        with:
          verification_type: failure
          outcome: ${{ steps.test_push_existing.outcome }}
          expected_error: "model with same version already exists"
          test_name: "test-push-existing-record"

  test-push-and-sign-success:
    name: Test push and sign with valid key
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Set version
        id: set_version
        uses: ./.github/actions/set-version
        with:
          version: ${{ inputs.record_version }}

      - name: Agent directory push and sign action
        id: test_push_and_sign
        uses: ./
        with:
          dirctl_client_id: ${{ secrets.DIRCTL_APIKEY_CLIENT_ID }}
          dirctl_secret: ${{ secrets.DIRCTL_APIKEY_SECRET }}
          record_file: ${{ env.TEST_RECORD }}
          organization_name: "test-github-actions-org"
          record_name: "gha-test-signed-record"
          record_version: ${{ steps.set_version.outputs.version }}
          cosign_private_key: ${{ secrets.COSIGN_KEY }}
          cosign_private_key_password: ${{ secrets.COSIGN_PASSWORD }}

      - name: Verify and upload
        uses: ./.github/actions/verify-and-upload
        with:
          verification_type: push_and_sign_success
          outcome: ${{ steps.test_push_and_sign.outcome }}
          test_name: "test-push-and-sign-success"

  test-push-success-sign-failure:
    name: Test push succeeds but sign fails with invalid key
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Set version
        id: set_version
        uses: ./.github/actions/set-version
        with:
          version: ${{ inputs.record_version }}

      - name: Agent directory push and sign action with invalid key
        id: test_push_sign_fail
        uses: ./
        continue-on-error: true
        with:
          dirctl_client_id: ${{ secrets.DIRCTL_APIKEY_CLIENT_ID }}
          dirctl_secret: ${{ secrets.DIRCTL_APIKEY_SECRET }}
          record_file: ${{ env.TEST_RECORD }}
          organization_name: "test-github-actions-org"
          record_name: "gha-test-sign-fail-record"
          record_version: ${{ steps.set_version.outputs.version }}
          cosign_private_key: ${{ secrets.COSIGN_KEY }}
          cosign_private_key_password: "wrong-cosign-password"

      - name: Verify and upload
        uses: ./.github/actions/verify-and-upload
        with:
          verification_type: push_success_sign_failure
          outcome: ${{ steps.test_push_sign_fail.outcome }}
          expected_error: "Failed to sign"
          test_name: "test-push-success-sign-failure"

  test-push-to-wrong-organization:
    name: Test push with organization mismatch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Set version
        id: set_version
        uses: ./.github/actions/set-version
        with:
          version: ${{ inputs.record_version }}

      - name: Agent directory push action
        id: test_wrong_org_push
        uses: ./
        continue-on-error: true
        with:
          dirctl_client_id: ${{ secrets.DIRCTL_APIKEY_CLIENT_ID }}
          dirctl_secret: ${{ secrets.DIRCTL_APIKEY_SECRET }}
          record_file: ${{ env.TEST_RECORD }}
          organization_name: "test-github-actions-org-2"
          record_name: "gha-test-record"
          record_version: ${{ steps.set_version.outputs.version }}

      - name: Verify and upload
        uses: ./.github/actions/verify-and-upload
        with:
          verification_type: failure
          outcome: ${{ steps.test_wrong_org_push.outcome }}
          expected_error: "API key does not belong to the organization"
          test_name: "test-push-to-wrong-organization"
